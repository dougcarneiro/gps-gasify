<div class="flex flex-col md:flex-row md:justify-between md:items-center mb-5 gap-4">
  <!-- Filter Buttons Section -->
  <div class="w-full md:w-auto flex justify-center">
    <mat-button-toggle-group class="flex flex-wrap" [(ngModel)]="activePreset" aria-label="Filtros de Data Predefinidos">
      <mat-button-toggle [disabled]="isLoading" [value]="1" (click)="applyDateFilterPreset(1)">Hoje</mat-button-toggle>
      <mat-button-toggle [disabled]="isLoading" [value]="7" (click)="applyDateFilterPreset(7)">Últimos 7 dias</mat-button-toggle>
      <mat-button-toggle [disabled]="isLoading" [value]="15" (click)="applyDateFilterPreset(15)">Últimos 15 dias</mat-button-toggle>
      <mat-button-toggle [disabled]="isLoading" [value]="-1" (click)="applyCurrentMonthDateRange()">Mês Atual</mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- Display Size Buttons Section -->
  <div class="w-full md:w-auto hidden lg:block">
    <mat-button-toggle-group class="flex flex-wrap" [(ngModel)]="activeDisplaySize" aria-label="Definir Tamanho de Exibição">
      <mat-button-toggle [value]="1" (click)="applyDisplaySize(1)">
        <mat-icon>view_comfy</mat-icon>
      </mat-button-toggle>

      <mat-button-toggle [value]="2" (click)="applyDisplaySize(2)">
        <mat-icon>view_cozy</mat-icon>
      </mat-button-toggle>
      <mat-button-toggle [value]="3" (click)="applyDisplaySize(3)">
        <mat-icon>view_stream</mat-icon>
      </mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- Dashboard Refresh Button Section -->
  <div class="w-full md:w-auto flex items-center">
    <div class="pb-4 mr-5">
      <button mat-mini-fab aria-label="Recarregar dashboard" [disabled]="isLoading" class="!h-[35px] !w-[35px]" (click)="onDateRangeChange()">
        <mat-icon class="dashboard-refresh-icon">refresh</mat-icon>
      </button>
    </div>

  <!-- Date Range Filter Section -->
    <mat-form-field class="w-full" appearance="fill">
      <mat-label>Período</mat-label>
      <mat-date-range-input [formGroup]="dateRange" [disabled]="isLoading" [min]="minDate" [max]="maxDate" [rangePicker]="picker" (dateChange)="onDateRangeChange()">
        <input readonly id="start-date-input" matStartDate placeholder="De" formControlName="start" (dateChange)="onDateRangeChange(true)">
        <input readonly id="end-date-input" matEndDate placeholder="Até" formControlName="end" (dateChange)="onDateRangeChange()">
      </mat-date-range-input>
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-date-range-picker #picker></mat-date-range-picker>
    </mat-form-field>
  </div>
</div>

<!-- Dashboard Container -->
<div class="grid grid-cols-1 gap-5 p-0 md:p-5"
     [ngClass]="{
       'lg:grid-cols-3': activeDisplaySize == 1,
       'lg:grid-cols-2': activeDisplaySize == 2,
     }">
  <div *ngFor="let config of chartConfigs"
       class="p-4 bg-white rounded-lg shadow-md col-span-1 flex flex-col min-h-[350px]">

    <!-- Card Header -->
    <div class="w-full flex items-start justify-between mb-4 flex-shrink-0">
      <h2 class="text-md md:text-lg text-start text-gray-800 font-semibold">{{ config.title }}</h2>
      <!-- Toggle Section -->
      <div class="flex flex-col">
        @for (toggle of config.toggleSlide; track toggle.label) {
          <div class="flex items-center justify-start w-full mb-1">
            <mat-slide-toggle
              class="transform scale-75"
              [disabled]="!config.isLoaded"
              [checked]="toggle.initialValue ?? false"
              (change)="toggleChange(config)"
              [aria-label]="toggle.label">
            </mat-slide-toggle>
            <span class="text-[12px] md:text-sm mr-4">{{ toggle.label }}</span>
          </div>
        }
      </div>
    </div>

    <div class="flex-1 flex flex-col ">
      @if (!config.isLoaded) {
        <div class="flex-1 flex justify-center items-center h-full w-full">
          <mat-spinner diameter="50"></mat-spinner>
        </div>
      } @else if (config.failedLoad) {
        <div class="flex-1 flex items-center justify-center">
          <div class="h-1/2 w-full flex flex-col items-center justify-center">
            <div class="flex flex-col items-center justify-center">
              <mat-icon class="text-red-500 chart-error-icon" fontIcon="error"></mat-icon>
              <p class="text-black text-center">Não foi possível carregar os dados.<br>Por favor, tente novamente.</p>
            </div>
            <div class="mt-8">
              <button mat-fab aria-label="Recarregar chart">
                <mat-icon (click)="refetchChartData(config)" class="text-blue-900 chart-error-icon">refresh</mat-icon>
              </button>
            </div>
          </div>
        </div>
      } @else {

        <div class="flex-1 flex flex-col min-h-0">
          @if (!config.noDataFound) {
            <app-generic-chart class="flex-1 min-h-0" [chartOptions]="config.chartOptions"></app-generic-chart>
            @if (config.totalDisplay && !config.definition.hideTotalSpan) {
              <p class="flex-shrink-0 mt-2 text-base font-bold text-center text-gray-600">{{ config.totalDisplay }}</p>
            }
          } @else {
            <div class="flex-1 flex items-center justify-center">
              <p class="text-gray-500 font-bold mx-5">Nenhum dado encontrado para o período selecionado.</p>
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>
